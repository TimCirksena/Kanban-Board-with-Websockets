<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link href="/styles/singleBoard_style.css" rel="stylesheet">
    <link href="/scripts/singleBoard_script.js" rel="script">
    <title>My Tiles Page</title>
    <meta charset="UTF-8">
</head>
<body>

<a href="http://localhost:8080/kanban" class="back-button">Back</a>
<div id="boardKanban">
    <h1>{boardTitel.titel}</h1>

</div>

<div style="position: fixed; bottom: 20px; right: 20px;">
    <form style="display: flex; align-items: center;">
        <label id="titelBoardInput_label">
            <input type="text" id="input-field" placeholder="Titel der Liste">

        </label>
        <button type="submit" id="add-button" class="add-button">+</button>
    </form>
</div>
<script src="/scripts/singleBoard_script.js"></script>
<script>
    let dragged;
    {#for listeKanban in listeKanbans}
    var newListKanbanDiv = createKanbanListElement("{listeKanban.titel}",{listeKanban.listeId});
    {#for elementKanban in listeKanban.stubElementDTOS}
    newListKanbanDiv.appendChild(createCard("{elementKanban.titel}"));
    {/for}
    {/for}

    var socket = new WebSocket("ws://localhost:8080/kanban/board");
    socket.onmessage = function (event) {
        var message = JSON.parse(event.data);
        console.log(message);
        if (message.type === "liste_kanban_created") {
            createKanbanListElement(message.titel, message.listeId);
        }
        if(message.type === "liste_kanban_deleted"){
            document.getElementById("liste" + message.listeId).remove();
        }
    };
    //New List-Item
    document.getElementById("add-button").addEventListener("click", function (event) {
        event.preventDefault(); // prevent the form from submitting

        var inputField = document.getElementById("input-field");
        var listKanbanTitel = inputField.value;
        var obj = new Object();
        var currentUrl = window.location.href;
        var boardId = currentUrl.substring(currentUrl.lastIndexOf('/') + 1);
        obj.boardId = boardId;
        obj.titel = listKanbanTitel;

        var jsonString = JSON.stringify(obj);
        console.log(jsonString);
        var request = new Request("http://localhost:8080/kanban/board/PostForList", {
            method: "POST",
            body: jsonString,
            headers: { "Content-Type": "application/json"}
        });
        // mit fetch zu quarkus markus senden
        fetch(request)
            .then(function (response) {
                // popups erstellen, die dem user feedback geben
                if (response.ok) {
                    alert("Liste erstellt!");
                } else {
                    alert("Fehler bei erstellen der Liste" + response.status);
                }
            })
            .catch(function (error) {
                alert("Fehler bei erstellen der Liste: " + error);
            });
    });

    function deleteListe(listeId, boardId){

        var obj = new Object();
        obj.listeId = listeId;
        obj.boardId = boardId;
        var jsonString = JSON.stringify(obj);

        var request = new Request("http://localhost:8080/kanban/board", {
            method: "DELETE",
            body: jsonString,
            headers: { "Content-Type" : "application/json"}
        });
        // mit fetch zu quarkus markus senden
        fetch(request)
            .then(function (response) {
                // popups erstellen, die dem user feedback geben
                if (response.ok) {
                    console.log("Die Liste wurde deleted")

                } else {
                    alert("Fehler beim löschen der Liste " + response.status);
                }
            })
            .catch(function (error) {
                alert("Fehler beim löschen der Liste: " + error);
            });
    }

    function createKanbanListElement(titel, listeId) {
        // Create new dropzone element
        var newListKanbanDiv = document.createElement("div");
        newListKanbanDiv.classList.add("dropzone");
        newListKanbanDiv.setAttribute("id", "color-picker" + listeId);
        newListKanbanDiv.id = "liste" + listeId;

        // Create new h2 element for the title
        var newTitle = document.createElement("h2");
        newTitle.classList.add("list-title");
        newTitle.innerHTML = titel;

        // Create new label for color picker
        var colorPickerLabel = document.createElement("label");
        colorPickerLabel.setAttribute("for", "color-picker");
        colorPickerLabel.innerHTML = "Background color: ";

        // Create delete button
        var deleteButton = document.createElement("button");
        deleteButton.classList.add("delete-kanban");
        deleteButton.id = "delete" + listeId;
        deleteButton.innerHTML = "X";
        deleteButton.addEventListener("click", function (e) {
            var currentUrl = window.location.href;
            var boardId = currentUrl.substring(currentUrl.lastIndexOf('/') + 1);
            deleteListe(listeId, boardId);
        });
        newListKanbanDiv.appendChild(deleteButton);

        // Create new color picker input
        var colorPickerInput = document.createElement("input");
        colorPickerInput.setAttribute("type", "color");
        colorPickerInput.setAttribute("id", "color-picker");
        colorPickerInput.setAttribute("name", "color-picker");
        colorPickerInput.setAttribute("style", "width: 30px; height: 15px;");
        colorPickerInput.addEventListener("change", function () {
            var parent = this.parentElement.parentElement;
            parent.style.backgroundColor = this.value;
        });

        var addElementButton = document.createElement("button");
        addElementButton.innerHTML = "+ Element hinzufügen";
        addElementButton.classList.add("add-element-button");
        addElementButton.addEventListener("click", function (event){
            addElementToList(listeId);
        })

        var eButtonDiv = document.createElement("div");
        eButtonDiv.classList.add("element-button-div")
        eButtonDiv.appendChild(addElementButton);

        // Append elements to new dropzone element
        newListKanbanDiv.appendChild(newTitle);
        newListKanbanDiv.appendChild(eButtonDiv);
        newListKanbanDiv.appendChild(colorPickerLabel);
        colorPickerLabel.appendChild(colorPickerInput);

        // Append new dropzone element to boardKanban div
        document.getElementById("boardKanban").appendChild(newListKanbanDiv);
        dragzone();

        return newListKanbanDiv;
    }

    function createCard(title) {
        // Create card element
        var card = document.createElement("div");
        card.setAttribute("draggable", "true");
        card.classList.add("card", "draggable");
        card.innerHTML = title;
        return card;
    }

    function addElementToList(listeId){

    }


</script>
</body>
</html>